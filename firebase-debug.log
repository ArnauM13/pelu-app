[debug] [2025-08-05T18:26:41.882Z] ----------------------------------------------------------------------
[debug] [2025-08-05T18:26:41.886Z] Command:       C:\nvm4w\nodejs\node.exe C:\nvm4w\nodejs\node_modules\firebase-tools\lib\bin\firebase.js deploy --only firestore:rules --debug
[debug] [2025-08-05T18:26:41.887Z] CLI Version:   14.10.1
[debug] [2025-08-05T18:26:41.887Z] Platform:      win32
[debug] [2025-08-05T18:26:41.887Z] Node Version:  v22.14.0
[debug] [2025-08-05T18:26:41.887Z] Time:          Tue Aug 05 2025 20:26:41 GMT+0200 (hora de verano de Europa central)
[debug] [2025-08-05T18:26:41.887Z] ----------------------------------------------------------------------
[debug] 
[debug] [2025-08-05T18:26:42.072Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2025-08-05T18:26:42.074Z] > authorizing via signed-in user (arnaumm98@gmail.com)
[debug] [2025-08-05T18:26:42.074Z] [iam] checking project peluapp-a5ced for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2025-08-05T18:26:42.075Z] Checked if tokens are valid: false, expires at: 1754398588128
[debug] [2025-08-05T18:26:42.076Z] Checked if tokens are valid: false, expires at: 1754398588128
[debug] [2025-08-05T18:26:42.076Z] > refreshing access token with scopes: []
[debug] [2025-08-05T18:26:42.078Z] >>> [apiv2][query] POST https://www.googleapis.com/oauth2/v3/token [none]
[debug] [2025-08-05T18:26:42.078Z] >>> [apiv2][body] POST https://www.googleapis.com/oauth2/v3/token [omitted]
[debug] [2025-08-05T18:26:42.370Z] <<< [apiv2][status] POST https://www.googleapis.com/oauth2/v3/token 200
[debug] [2025-08-05T18:26:42.371Z] <<< [apiv2][body] POST https://www.googleapis.com/oauth2/v3/token [omitted]
[debug] [2025-08-05T18:26:42.395Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/peluapp-a5ced:testIamPermissions [none]
[debug] [2025-08-05T18:26:42.396Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/peluapp-a5ced:testIamPermissions x-goog-quota-user=projects/peluapp-a5ced
[debug] [2025-08-05T18:26:42.398Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/peluapp-a5ced:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2025-08-05T18:26:43.192Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/peluapp-a5ced:testIamPermissions 200
[debug] [2025-08-05T18:26:43.193Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/peluapp-a5ced:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'peluapp-a5ced'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2025-08-05T18:26:43.204Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:43.204Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:43.205Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced:test [none]
[debug] [2025-08-05T18:26:43.205Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced:test [omitted]
[debug] [2025-08-05T18:26:43.705Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced:test 200
[debug] [2025-08-05T18:26:43.706Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":19,"column":14,"currentOffset":536,"endOffset":548},"description":"Unused function: hasPermission.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":21,"column":9,"currentOffset":608,"endOffset":613},"description":"Invalid function name: exists.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":21,"column":57,"currentOffset":656,"endOffset":662},"description":"Invalid variable name: request.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":22,"column":9,"currentOffset":687,"endOffset":689},"description":"Invalid function name: get.","severity":"WARNING"},{"sourcePosition":{"fileName":"firestore.rules","line":22,"column":54,"currentOffset":732,"endOffset":738},"description":"Invalid variable name: request.","severity":"WARNING"}]}
[warn] !  [W] 19:14 - Unused function: hasPermission. 
[warn] !  [W] 21:9 - Invalid function name: exists. 
[warn] !  [W] 21:57 - Invalid variable name: request. 
[warn] !  [W] 22:9 - Invalid function name: get. 
[warn] !  [W] 22:54 - Invalid variable name: request. 
[info] +  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2025-08-05T18:26:43.710Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:43.711Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:43.712Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/peluapp-a5ced/databases/(default) [none]
[debug] [2025-08-05T18:26:44.110Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/peluapp-a5ced/databases/(default) 200
[debug] [2025-08-05T18:26:44.110Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/peluapp-a5ced/databases/(default) {"name":"projects/peluapp-a5ced/databases/(default)","uid":"ebf49232-5d19-4db9-a961-5f1e9edd3e2b","createTime":"2025-07-15T16:12:29.985002Z","updateTime":"2025-07-15T16:12:29.985002Z","locationId":"eur3","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2025-08-05T17:26:43.463316Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"e","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"etag":"IO+b5+2l9I4DMPmxleegv44D"}
[debug] [2025-08-05T18:26:44.112Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:44.113Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:44.114Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases pageSize=10&pageToken=
[debug] [2025-08-05T18:26:44.829Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases 200
[debug] [2025-08-05T18:26:44.830Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases {"releases":[{"name":"projects/peluapp-a5ced/releases/cloud.firestore","rulesetName":"projects/peluapp-a5ced/rulesets/3e7032e7-32e4-454e-b610-db2aa54fbc19","createTime":"2025-07-15T16:12:39.281825Z","updateTime":"2025-07-25T19:09:52.153200Z"}]}
[debug] [2025-08-05T18:26:44.831Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:44.831Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:44.832Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets/3e7032e7-32e4-454e-b610-db2aa54fbc19 [none]
[debug] [2025-08-05T18:26:45.496Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets/3e7032e7-32e4-454e-b610-db2aa54fbc19 200
[debug] [2025-08-05T18:26:45.497Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets/3e7032e7-32e4-454e-b610-db2aa54fbc19 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2025-08-05T18:26:45.500Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:45.500Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:45.501Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets [none]
[debug] [2025-08-05T18:26:45.501Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets [omitted]
[debug] [2025-08-05T18:26:46.317Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets 200
[debug] [2025-08-05T18:26:46.318Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/rulesets {"name":"projects/peluapp-a5ced/rulesets/bf1c712e-9b09-488a-baa8-59999b09e61d","source":{"files":[{"content":"rules_version = '2';\r\nservice cloud.firestore {\r\n  match /databases/{database}/documents {\r\n    // Helper functions\r\n    function isAuthenticated() {\r\n      return request.auth != null;\r\n    }\r\n\r\n    function isOwner(userId) {\r\n      return request.auth.uid == userId;\r\n    }\r\n\r\n    function isAdmin() {\r\n      return isAuthenticated() &&\r\n        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&\r\n        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';\r\n    }\r\n\r\n    function hasPermission(permission) {\r\n      return isAuthenticated() &&\r\n        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&\r\n        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions[permission] == true;\r\n    }\r\n\r\n    // Col·lecció d'usuaris\r\n    match /users/{userId} {\r\n      // Usuaris poden llegir/escriure només les seves pròpies dades\r\n      allow read, write: if isOwner(userId);\r\n\r\n      // Administradors poden llegir totes les dades d'usuari\r\n      allow read: if isAdmin();\r\n\r\n      // Administradors poden actualitzar rols i permisos\r\n      allow update: if isAdmin() &&\r\n        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role', 'permissions', 'updatedAt']));\r\n    }\r\n\r\n    // Col·lecció de cites (bookings) - totes les cites es gestionen com a reserves\r\n    // Les regles estan definides a la secció de bookings més avall\r\n\r\n    // Col·lecció de serveis\r\n    match /services/{serviceId} {\r\n      // Tots els usuaris autenticats poden llegir serveis\r\n      allow read: if request.auth != null;\r\n\r\n      // Només administradors poden crear/actualitzar/eliminar serveis\r\n      allow write: if isAdmin();\r\n    }\r\n\r\n    // Col·lecció de reserves (bookings)\r\n    match /bookings/{bookingId} {\r\n      // Permetre creació de reserves (anònimes i autenticades)\r\n      allow create: if true;\r\n\r\n      // Usuaris poden llegir/escriure només les seves pròpies reserves\r\n      allow read, write: if request.auth != null &&\r\n        resource.data.uid == request.auth.uid;\r\n\r\n      // Permetre accés amb token d'edició (per usuaris anònims)\r\n      allow read: if resource.data.editToken == request.query.token;\r\n\r\n      // Permetre actualització amb token d'edició (per usuaris anònims)\r\n      allow update: if resource.data.editToken == request.query.token &&\r\n        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['nom', 'email', 'data', 'hora', 'serviceId', 'serviceName', 'duration', 'price', 'notes', 'uid', 'updatedAt']));\r\n\r\n      // Administradors poden gestionar totes les reserves (llegir, actualitzar i eliminar)\r\n      allow read, write: if isAdmin();\r\n    }\r\n\r\n    // Col·lecció de preferències d'idioma\r\n    match /userPreferences/{userId} {\r\n      // Usuaris poden llegir/escriure només les seves pròpies preferències\r\n      allow read, write: if isOwner(userId);\r\n    }\r\n\r\n    // Col·lecció de configuració del sistema\r\n    match /system/{document} {\r\n      // Només administradors poden llegir i escriure configuració del sistema\r\n      allow read, write: if isAdmin();\r\n    }\r\n\r\n    // Regla per defecte: denegar tot el que no estigui explícitament permès\r\n    match /{document=**} {\r\n      allow read, write: if false;\r\n    }\r\n  }\r\n}\r\n","name":"firestore.rules"}]},"createTime":"2025-08-05T18:26:45.662511Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2025-08-05T18:26:46.319Z] [rules] created ruleset projects/peluapp-a5ced/rulesets/bf1c712e-9b09-488a-baa8-59999b09e61d
[debug] [2025-08-05T18:26:46.321Z] [rules] releasing cloud.firestore/(default) with ruleset projects/peluapp-a5ced/rulesets/bf1c712e-9b09-488a-baa8-59999b09e61d
[debug] [2025-08-05T18:26:46.322Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:46.322Z] Checked if tokens are valid: true, expires at: 1754422001371
[debug] [2025-08-05T18:26:46.323Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases/cloud.firestore/(default) [none]
[debug] [2025-08-05T18:26:46.324Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases/cloud.firestore/(default) {"release":{"name":"projects/peluapp-a5ced/releases/cloud.firestore/(default)","rulesetName":"projects/peluapp-a5ced/rulesets/bf1c712e-9b09-488a-baa8-59999b09e61d"}}
[debug] [2025-08-05T18:26:46.738Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases/cloud.firestore/(default) 200
[debug] [2025-08-05T18:26:46.739Z] <<< [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/peluapp-a5ced/releases/cloud.firestore/(default) {"name":"projects/peluapp-a5ced/releases/cloud.firestore","rulesetName":"projects/peluapp-a5ced/rulesets/bf1c712e-9b09-488a-baa8-59999b09e61d","createTime":"2025-07-15T16:12:39.281825Z","updateTime":"2025-08-05T18:26:46.068795Z"}
[debug] [2025-08-05T18:26:46.740Z] [rules] updated release projects/peluapp-a5ced/releases/cloud.firestore
[info] +  firestore: released rules firestore.rules to cloud.firestore 
[info] 
[info] +  Deploy complete! 
[info] 
[info] Project Console: https://console.firebase.google.com/project/peluapp-a5ced/overview
