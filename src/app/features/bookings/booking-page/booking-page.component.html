<!-- Unified Booking Page - Responsive Design -->
<div class="container" [style.view-transition-name]="'booking-container'">

  <!-- ===== NEXT APPOINTMENT SECTION (Above Title - Only on Service Step, Not for Admin) ===== -->
  @if (currentStep() === 'service' && (userAppointments() || []).length > 0 && !isAdmin()) {
    <div class="content-section">
      <pelu-next-appointment [bookings]="userAppointments() || []"></pelu-next-appointment>
    </div>
  }

  <!-- ===== SHARED TITLE (First Step Only - Desktop: Not for Admin, Mobile: For Everyone) ===== -->
  @if (currentStep() === 'service' && (!isDesktop() || !isAdmin())) {
    <div class="shared-title-section">
      <pelu-title
        [title]="'BOOKING.TITLE'"
        [subtitle]="'BOOKING.SUBTITLE'"
      ></pelu-title>
    </div>
  }

  <!-- ===== DESKTOP LAYOUT ===== -->
  @if (isDesktop()) {
    <pelu-desktop-layout
      (timeSlotSelected)="onDesktopTimeSlotSelected($event)"
    ></pelu-desktop-layout>
  }

  <!-- ===== MOBILE LAYOUT ===== -->
  @if (isMobile()) {
    <div class="mobile-layout">

      <!-- User appointment limit validation message -->
      @if (hasReachedAppointmentLimit()) {
        <div class="content-section" style="margin-bottom: 1rem;">
          <pelu-no-appointments-message
            type="warning"
            icon="⚠️"
            iconColor="#f59e0b"
            [title]="'BOOKING.USER_LIMIT_REACHED_TITLE'"
            [message]="'BOOKING.USER_LIMIT_REACHED_MESSAGE'"
            actionText="BOOKING.VIEW_MY_APPOINTMENTS"
            [actionCallback]="onViewMyAppointments"
            [showAction]="true"
          />
        </div>
      }

      <!-- Warning when no appointments are available in current view -->
      @if (currentStep() === 'datetime' && hasNoAvailableAppointments()) {
        <div class="content-section" style="margin-bottom: 1rem;">
          <pelu-no-appointments-message
            type="warning"
            icon="⚠️"
            iconColor="#f59e0b"
            [title]="'BOOKING.NO_APPOINTMENTS_TITLE'"
            [message]="'BOOKING.NO_APPOINTMENTS_MESSAGE'"
          />
        </div>
      }

      <!-- Warning when selected day has no available appointments -->
      @if (currentStep() === 'datetime' && selectedDate() && hasNoAvailableAppointmentsForSelectedDay()) {
        <div class="content-section" style="margin-bottom: 1rem;">
          <pelu-no-appointments-message
            type="warning"
            icon="⚠️"
            iconColor="#f59e0b"
            [title]="'COMMON.SELECTION.NO_APPOINTMENTS_FOR_DAY'"
            [message]="'COMMON.SELECTION.NO_APPOINTMENTS_FOR_DAY_MESSAGE'"
          />
        </div>
      }

      <!-- Warning when no time slots are available for the selected service -->
      @if (currentStep() === 'datetime' && selectedService() && hasNoAvailableTimeSlotsForService()) {
        <div class="content-section" style="margin-bottom: 1rem;">
          <pelu-no-appointments-message
            type="warning"
            icon="⚠️"
            iconColor="#f59e0b"
            [title]="'BOOKING.NO_TIME_SLOTS_FOR_SERVICE_TITLE'"
            [message]="'BOOKING.NO_TIME_SLOTS_FOR_SERVICE_MESSAGE'"
            actionText="BOOKING.SELECT_DIFFERENT_SERVICE"
            [actionCallback]="goToServiceStep"
            [showAction]="true"
          />
        </div>
      }

      <!-- Step Content -->
      <div class="step-content">

        <!-- Step 1: Service Selection -->
        @if (currentStep() === 'service') {
          <pelu-service-selection-step
            (serviceSelected)="onServiceSelected($event)"
          ></pelu-service-selection-step>
        }

        <!-- Step 2: Date and Time Selection -->
        @if (currentStep() === 'datetime') {
          <pelu-datetime-selection-step
            (dateSelected)="onDateSelected($event)"
            (timeSlotSelected)="onTimeSlotSelectedMobile($event)"
            (viewModeChanged)="toggleViewMode()"
          ></pelu-datetime-selection-step>
        }

        <!-- Step 3: Confirmation -->
        @if (currentStep() === 'confirmation') {
          <pelu-confirmation-step
            (clientNameChanged)="onClientNameChanged($event)"
            (emailChanged)="onEmailChanged($event)"
          ></pelu-confirmation-step>
        }

        <!-- Step 4: Success -->
        @if (currentStep() === 'success') {
          <pelu-success-step
            (viewBookingDetail)="onViewBookingDetail()"
            (backToHome)="onBackToHome()"
            (addToCalendar)="addToCalendar()"
          ></pelu-success-step>
        }
      </div>

      <!-- Bottom Navigation (Mobile) -->
      @if (currentStep() !== 'success') {
        <pelu-mobile-navigation
          (goBack)="goBack()"
          (nextStep)="nextStep()"
        ></pelu-mobile-navigation>
      }
    </div>
  }

  <!-- ===== DESKTOP POPUPS ===== -->

  <!-- Service Selection Popup -->
  <pelu-service-selection-popup
    [open]="showServiceSelectionPopup()"
    [selectionDetails]="serviceSelectionDetails()"
    (serviceSelected)="onDesktopServiceSelected($event)"
    (cancelled)="onServiceSelectionCancelled()"
  ></pelu-service-selection-popup>

  <!-- Booking Confirmation Popup -->
  <pelu-booking-popup
    [open]="showBookingPopup()"
    [bookingDetails]="desktopBookingDetails()"
    (confirmed)="onDesktopBookingConfirmed($event)"
    (cancelled)="onBookingCancelled()"
    (clientNameChanged)="onDesktopClientNameChanged($event)"
    (emailChanged)="onDesktopEmailChanged($event)"
  ></pelu-booking-popup>

  <!-- Login Prompt Dialog -->
  <pelu-popup-dialog
    [config]="loginPromptDialogConfig()"
    (closed)="onLoginPromptClose()"
  ></pelu-popup-dialog>
</div>
