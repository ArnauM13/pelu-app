<div class="admin-services-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>üõ†Ô∏è {{ 'SERVICES.MANAGEMENT.TITLE' | translate }}</h1>
      <p>{{ 'SERVICES.MANAGEMENT.SUBTITLE' | translate }}</p>
    </div>
    <div class="header-actions">
      <pelu-button
        [label]="'SERVICES.MANAGEMENT.ADD_SERVICE' | translate"
        severity="primary"
        (clicked)="showCreateService()"
      >
      </pelu-button>
      <pelu-button
        [label]="'SERVICES.MANAGEMENT.CATEGORIES.CREATE_NEW_CATEGORY' | translate"
        severity="success"
        (clicked)="showCategoriesManager()"
      >
      </pelu-button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <pelu-loading-state [config]="loadingConfig"></pelu-loading-state>
  }

  <!-- Services Content -->
  @if (!isLoading()) {
    <div class="services-content">
      <!-- Services by Category -->
      @for (category of servicesByCategory(); track category.id) {
        <div class="service-category">
          <div class="category-header">
            <div class="category-info">
              <span class="category-icon">{{ getCategoryIcon(category.id) }}</span>
              <h2>{{ getCategoryName(category.id) }}</h2>
              <span class="service-count">({{ category.services.length }})</span>
            </div>
          </div>

          <div class="services-grid">
            @for (service of category.services; track service.id) {
              <pelu-service-card
                [service]="service"
                [showActions]="true"
                [showPopularBadge]="true"
                [showCategory]="true"
                [showDuration]="true"
                [showPrice]="true"
                [showDescription]="true"
                [clickable]="false"
                [selected]="false"
                [compact]="false"
                (editClick)="showEditService($event)"
                (deleteClick)="deleteService($event)"
                (togglePopularClick)="togglePopularStatus($event)"
              >
              </pelu-service-card>
            }
          </div>

          @if (category.services.length === 0) {
            <div class="empty-category">
              <p>{{ 'SERVICES.MANAGEMENT.NO_SERVICES_IN_CATEGORY' | translate }}</p>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Create Service Dialog -->
  <pelu-popup-dialog
    [isOpen]="showCreateDialog()"
    [config]="createServiceDialogConfig()"
    (closed)="cancelDialog()"
  >
    @if (serviceForm()) {
      <form [formGroup]="serviceForm()!" (ngSubmit)="createService()">
        <div class="service-form">
          <div class="form-section">
            <h3>{{ 'COMMON.BASIC_INFORMATION' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-text
                  formControlName="name"
                  [label]="'COMMON.NAME'"
                  [placeholder]="'SERVICES.MANAGEMENT.NAME_PLACEHOLDER'"
                  [required]="true"
                >
                </pelu-input-text>
                @if (isServiceFieldInvalid('name')) {
                  <div class="error-message">{{ getServiceFieldError('name') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-textarea
                  formControlName="description"
                  [label]="'COMMON.DESCRIPTION'"
                  [placeholder]="'SERVICES.MANAGEMENT.DESCRIPTION_PLACEHOLDER'"
                  [rows]="3"
                  [required]="true"
                >
                </pelu-input-textarea>
                @if (isServiceFieldInvalid('description')) {
                  <div class="error-message">{{ getServiceFieldError('description') }}</div>
                }
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.CATEGORY_AND_ICON' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-select
                  formControlName="category"
                  [label]="'COMMON.CATEGORY'"
                  [placeholder]="'SERVICES.MANAGEMENT.SELECT_CATEGORY'"
                  [required]="true"
                  [options]="categoryOptions()"
                >
                </pelu-input-select>
                @if (isServiceFieldInvalid('category')) {
                  <div class="error-message">{{ getServiceFieldError('category') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-select
                  formControlName="icon"
                  [label]="'SERVICES.MANAGEMENT.ICON'"
                  [placeholder]="'SERVICES.MANAGEMENT.SELECT_ICON'"
                  [options]="iconOptions"
                >
                  <!-- Template per l'element seleccionat -->
                  <ng-template #selectedItem let-selectedOption>
                    <div class="flex items-center gap-2" *ngIf="selectedOption">
                      <i [class]="selectedOption.value" class="text-lg"></i>
                      <span class="font-medium">{{ selectedOption.label }}</span>
                    </div>
                  </ng-template>

                  <!-- Template per les opcions del dropdown -->
                  <ng-template #item let-icon>
                    <div class="flex items-center gap-3 p-2">
                      <i [class]="icon.value" class="text-xl text-gray-600"></i>
                      <div>
                        <div class="font-medium">{{ icon.label }}</div>
                        <div class="text-sm text-gray-500">{{ icon.description }}</div>
                      </div>
                    </div>
                  </ng-template>

                  <!-- Template per l'encap√ßalament -->
                  <ng-template #header>
                    <div class="p-3 bg-blue-50 border-b border-blue-200">
                      <h4 class="font-semibold text-blue-800">Icones Disponibles</h4>
                      <p class="text-sm text-blue-600">Selecciona una icona per al servei</p>
                    </div>
                  </ng-template>
                </pelu-input-select>
                @if (isServiceFieldInvalid('icon')) {
                  <div class="error-message">{{ getServiceFieldError('icon') }}</div>
                }
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.PRICING_AND_DURATION' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-number
                  formControlName="price"
                  [label]="'COMMON.UNITS.PRICE_EURO'"
                  [placeholder]="'0.00'"
                  [required]="true"
                  [min]="0"
                  [max]="1000"
                  [step]="0.01"
                  [suffix]="'‚Ç¨'"
                >
                </pelu-input-number>
                @if (isServiceFieldInvalid('price')) {
                  <div class="error-message">{{ getServiceFieldError('price') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-number
                  formControlName="duration"
                  [label]="'COMMON.UNITS.DURATION_MINUTES'"
                  [placeholder]="'30'"
                  [required]="true"
                  [min]="5"
                  [max]="480"
                  [step]="5"
                  [suffix]="'min'"
                >
                </pelu-input-number>
                @if (isServiceFieldInvalid('duration')) {
                  <div class="error-message">{{ getServiceFieldError('duration') }}</div>
                }
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.OPTIONS' | translate }}</h3>
            <div class="form-field">
              <pelu-input-checkbox
                formControlName="popular"
                [label]="'SERVICES.MANAGEMENT.MARK_AS_POPULAR'"
              >
              </pelu-input-checkbox>
            </div>
          </div>
        </div>
      </form>
    }
  </pelu-popup-dialog>

  <!-- Edit Service Dialog -->
  <pelu-popup-dialog
    [isOpen]="showEditDialog()"
    [config]="editServiceDialogConfig()"
    (closed)="cancelDialog()"
  >
    @if (serviceForm()) {
      <form [formGroup]="serviceForm()!" (ngSubmit)="updateService()">
        <div class="service-form">
          <div class="form-section">
            <h3>{{ 'COMMON.BASIC_INFORMATION' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-text
                  formControlName="name"
                  [label]="'COMMON.NAME'"
                  [placeholder]="'SERVICES.MANAGEMENT.NAME_PLACEHOLDER'"
                  [required]="true"
                >
                </pelu-input-text>
                @if (isServiceFieldInvalid('name')) {
                  <div class="error-message">{{ getServiceFieldError('name') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-textarea
                  formControlName="description"
                  [label]="'COMMON.DESCRIPTION'"
                  [placeholder]="'SERVICES.MANAGEMENT.DESCRIPTION_PLACEHOLDER'"
                  [rows]="3"
                  [required]="true"
                >
                </pelu-input-textarea>
                @if (isServiceFieldInvalid('description')) {
                  <div class="error-message">{{ getServiceFieldError('description') }}</div>
                }
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.CATEGORY_AND_ICON' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-select
                  formControlName="category"
                  [label]="'COMMON.CATEGORY'"
                  [placeholder]="'SERVICES.MANAGEMENT.SELECT_CATEGORY'"
                  [required]="true"
                  [options]="categoryOptions()"
                >
                </pelu-input-select>
                @if (isServiceFieldInvalid('category')) {
                  <div class="error-message">{{ getServiceFieldError('category') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-select
                  formControlName="icon"
                  [label]="'SERVICES.MANAGEMENT.ICON'"
                  [placeholder]="'SERVICES.MANAGEMENT.SELECT_ICON'"
                  [options]="iconOptions"
                >
                  <!-- Template per l'element seleccionat -->
                  <ng-template #selectedItem let-selectedOption>
                    <div class="flex items-center gap-2" *ngIf="selectedOption">
                      <i [class]="selectedOption.value" class="text-lg"></i>
                      <span class="font-medium">{{ selectedOption.label }}</span>
                    </div>
                  </ng-template>

                  <!-- Template per les opcions del dropdown -->
                  <ng-template #item let-icon>
                    <div class="flex items-center gap-3 p-2">
                      <i [class]="icon.value" class="text-xl text-gray-600"></i>
                      <div>
                        <div class="font-medium">{{ icon.label }}</div>
                        <div class="text-sm text-gray-500">{{ icon.description }}</div>
                      </div>
                    </div>
                  </ng-template>

                  <!-- Template per l'encap√ßalament -->
                  <ng-template #header>
                    <div class="p-3 bg-blue-50 border-b border-blue-200">
                      <h4 class="font-semibold text-blue-800">Icones Disponibles</h4>
                      <p class="text-sm text-blue-600">Selecciona una icona per al servei</p>
                    </div>
                  </ng-template>
                </pelu-input-select>
                @if (isServiceFieldInvalid('icon')) {
                  <div class="error-message">{{ getServiceFieldError('icon') }}</div>
                }
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.PRICING_AND_DURATION' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-number
                  formControlName="price"
                  [label]="'COMMON.UNITS.PRICE_EURO'"
                  [placeholder]="'0.00'"
                  [required]="true"
                  [min]="0"
                  [max]="1000"
                  [step]="0.01"
                  [suffix]="'‚Ç¨'"
                >
                </pelu-input-number>
                @if (isServiceFieldInvalid('price')) {
                  <div class="error-message">{{ getServiceFieldError('price') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-number
                  formControlName="duration"
                  [label]="'COMMON.UNITS.DURATION_MINUTES'"
                  [placeholder]="'30'"
                  [required]="true"
                  [min]="5"
                  [max]="480"
                  [step]="5"
                  [suffix]="'min'"
                >
                </pelu-input-number>
                @if (isServiceFieldInvalid('duration')) {
                  <div class="error-message">{{ getServiceFieldError('duration') }}</div>
                }
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.OPTIONS' | translate }}</h3>
            <div class="form-field">
              <pelu-input-checkbox
                formControlName="popular"
                [label]="'SERVICES.MANAGEMENT.MARK_AS_POPULAR'"
              >
              </pelu-input-checkbox>
            </div>
          </div>
        </div>
      </form>
    }
  </pelu-popup-dialog>

  <!-- Categories Manager Dialog -->
  <pelu-popup-dialog
    [isOpen]="showCategoriesManagerDialog()"
    [config]="categoriesManagerDialogConfig()"
    (closed)="closeCategoriesManager()"
  >
    <div class="categories-manager">
      <div class="categories-header">
        <h3>{{ 'SERVICES.MANAGEMENT.CATEGORIES.EXISTING_CATEGORIES' | translate }}</h3>
        <pelu-button
          [label]="'SERVICES.MANAGEMENT.CATEGORIES.ADD_CATEGORY' | translate"
          severity="success"
          (clicked)="showCreateCategory()"
        >
        </pelu-button>
      </div>

      <div class="categories-grid">
        @for (category of serviceCategories(); track category.id) {
          <div class="category-card" [class.static-category]="!category.custom">
            <div class="category-info">
              <span class="category-icon">{{ category.icon }}</span>
              <div class="category-details">
                <h4>{{ category.name }}</h4>
                <div class="category-id">{{ category.id }}</div>
                @if (!category.custom) {
                  <span class="static-badge">{{ 'SERVICES.MANAGEMENT.CATEGORIES.STATIC_CATEGORY' | translate }}</span>
                }
              </div>
            </div>
            <div class="category-actions">
              @if (category.custom) {
                <pelu-button
                  label="‚úèÔ∏è"
                  variant="text"
                  severity="secondary"
                  [rounded]="true"
                  (clicked)="showEditCategory(category)"
                >
                </pelu-button>
                <pelu-button
                  label="üóëÔ∏è"
                  variant="text"
                  severity="danger"
                  [rounded]="true"
                  (clicked)="deleteCategory(category)"
                >
                </pelu-button>
              } @else {
                <span class="static-message">{{ 'SERVICES.MANAGEMENT.CATEGORIES.CANNOT_EDIT_STATIC' | translate }}</span>
              }
            </div>
          </div>
        }
      </div>

      @if (serviceCategories().length === 0) {
        <div class="empty-categories">
          <p>{{ 'SERVICES.MANAGEMENT.CATEGORIES.NO_CATEGORIES' | translate }}</p>
        </div>
      }
    </div>
  </pelu-popup-dialog>

  <!-- Create Category Dialog -->
  <pelu-popup-dialog
    [isOpen]="showCreateCategoryDialog()"
    [config]="createCategoryDialogConfig()"
    (closed)="cancelCategoryDialog()"
  >
    @if (categoryForm()) {
      <form [formGroup]="categoryForm()!" (ngSubmit)="createCategory()">
        <div class="category-form">
          <div class="form-section">
            <h3>{{ 'COMMON.BASIC_INFORMATION' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-text
                  formControlName="name"
                  [label]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_NAME'"
                  [placeholder]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_NAME_PLACEHOLDER'"
                  [required]="true"
                >
                </pelu-input-text>
                @if (isCategoryFieldInvalid('name')) {
                  <div class="error-message">{{ getCategoryFieldError('name') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-text
                  formControlName="id"
                  [label]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ID'"
                  [placeholder]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ID_PLACEHOLDER'"
                  [required]="true"
                >
                </pelu-input-text>
                @if (isCategoryFieldInvalid('id')) {
                  <div class="error-message">{{ getCategoryFieldError('id') }}</div>
                }
                <small class="form-help">Nom√©s lletres min√∫scules, n√∫meros i guions (ex: mi-categoria)</small>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.ICON_SELECTION' | translate }}</h3>
            <div class="form-field">
              <pelu-input-text
                formControlName="icon"
                [label]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ICON'"
                [placeholder]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ICON_PLACEHOLDER'"
                [required]="true"
                maxlength="2"
              >
              </pelu-input-text>
              @if (isCategoryFieldInvalid('icon')) {
                <div class="error-message">{{ getCategoryFieldError('icon') }}</div>
              }
              @if (categoryForm()?.get('icon')?.value) {
                <div class="icon-preview">
                  <span class="preview-icon">{{ categoryForm()?.get('icon')?.value }}</span>
                </div>
              }
              <small class="form-help">
                {{ 'SERVICES.MANAGEMENT.CATEGORIES.ICON_HELP' | translate }}
                <br />
                <strong>{{ 'SERVICES.MANAGEMENT.CATEGORIES.ICON_EXAMPLES' | translate }}:</strong> ‚úÇÔ∏è
                üßî üíÜ üíá üé® üë∂ ‚≠ê üîß üè† üöó üéµ üì± üíª üéÆ üèÉ‚Äç‚ôÇÔ∏è üßò‚Äç‚ôÄÔ∏è
              </small>
            </div>
          </div>
        </div>
      </form>
    }
  </pelu-popup-dialog>

  <!-- Edit Category Dialog -->
  <pelu-popup-dialog
    [isOpen]="showEditCategoryDialog()"
    [config]="editCategoryDialogConfig()"
    (closed)="cancelCategoryDialog()"
  >
    @if (categoryForm()) {
      <form [formGroup]="categoryForm()!" (ngSubmit)="updateCategory()">
        <div class="category-form">
          <div class="form-section">
            <h3>{{ 'COMMON.BASIC_INFORMATION' | translate }}</h3>
            <div class="form-grid">
              <div class="form-field">
                <pelu-input-text
                  formControlName="name"
                  [label]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_NAME'"
                  [placeholder]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_NAME_PLACEHOLDER'"
                  [required]="true"
                >
                </pelu-input-text>
                @if (isCategoryFieldInvalid('name')) {
                  <div class="error-message">{{ getCategoryFieldError('name') }}</div>
                }
              </div>
              <div class="form-field">
                <pelu-input-text
                  formControlName="id"
                  [label]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ID'"
                  [placeholder]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ID_PLACEHOLDER'"
                  [required]="true"
                  [readonly]="true"
                >
                </pelu-input-text>
                <small class="form-help">L'ID de la categoria no es pot modificar</small>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>{{ 'COMMON.ICON_SELECTION' | translate }}</h3>
            <div class="form-field">
              <pelu-input-text
                formControlName="icon"
                [label]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ICON'"
                [placeholder]="'SERVICES.MANAGEMENT.CATEGORIES.CATEGORY_ICON_PLACEHOLDER'"
                [required]="true"
                maxlength="2"
              >
              </pelu-input-text>
              @if (isCategoryFieldInvalid('icon')) {
                <div class="error-message">{{ getCategoryFieldError('icon') }}</div>
              }
              @if (categoryForm()?.get('icon')?.value) {
                <div class="icon-preview">
                  <span class="preview-icon">{{ categoryForm()?.get('icon')?.value }}</span>
                </div>
              }
              <small class="form-help">
                {{ 'SERVICES.MANAGEMENT.CATEGORIES.ICON_HELP' | translate }}
                <br />
                <strong>{{ 'SERVICES.MANAGEMENT.CATEGORIES.ICON_EXAMPLES' | translate }}:</strong> ‚úÇÔ∏è
                üßî üíÜ üíá üé® üë∂ ‚≠ê üîß üè† üöó üéµ üì± üíª üéÆ üèÉ‚Äç‚ôÇÔ∏è üßò‚Äç‚ôÄÔ∏è
              </small>
            </div>
          </div>
        </div>
      </form>
    }
  </pelu-popup-dialog>

  <!-- Alert Dialog -->
  @if (showAlertDialog()) {
    <pelu-alert-popup
      [data]="alertData()!"
      (confirmed)="onAlertConfirmed()"
      (cancelled)="onAlertCancelled()"
    >
    </pelu-alert-popup>
  }

</div>
