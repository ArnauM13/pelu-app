<div class="calendar-container">
  <!-- Loader only on first load -->
  @if (!isBookingsLoaded()) {
    <pelu-calendar-loader />
  }

  <!-- Calendar Content (only show when bookings are loaded) -->
  @if (isBookingsLoaded()) {
    <!-- Calendar Header -->
    <pelu-calendar-header
      [mainTitle]="'Setmana del ' + formatPopupDate(format(viewDate(), 'yyyy-MM-dd'))"
      [viewDateInfo]="getViewDateInfo()"
      [businessDaysInfo]="getBusinessDaysInfo()"
      [canNavigateToPreviousWeek]="canNavigateToPreviousWeek()"
      [currentViewDate]="viewDate()"
      (today)="today()"
      (previousWeek)="previousWeek()"
      (nextWeek)="nextWeek()"
      (dateChange)="onDateChange($event)"
    />

    <!-- Calendar Body -->
    <div class="calendar-body">
      <div class="horizontal-week-view" [style.--calendar-slot-count]="timeSlots().length">
        <!-- Time Column -->
        <pelu-calendar-time-column [timeSlots]="timeColumnSlots()"> </pelu-calendar-time-column>

        <!-- Day Columns Container -->
        <div class="day-columns-container">
          @for (dayColumn of dayColumnsData(); track dayColumn.date; let i = $index) {
            <pelu-calendar-day-column
              [data]="dayColumn"
              (timeSlotClicked)="onTimeSlotClick($event.date, $event.time)"
              (appointmentClicked)="openAppointmentPopup($event)"
              (dropZoneMouseEnter)="onDropZoneMouseEnter($event, dayColumn.date)"
              (dropZoneMouseMove)="onDropZoneMouseMove($event, dayColumn.date)"
              (dropZoneDrop)="onDropZoneDrop($event, dayColumn.date)"
              (dropZoneDragOver)="onDropZoneDragOver($event)"
            >
            </pelu-calendar-day-column>
          }
        </div>
      </div>
    </div>

    <!-- Appointment Detail Popup -->
    <pelu-appointment-detail-popup
      [open]="showDetailPopup()"
      [booking]="selectedAppointment()"
      (closed)="onAppointmentDetailPopupClosed()"
      (deleted)="onAppointmentDeleted($event)"
      (editRequested)="onAppointmentEditRequested($event)"
    >
    </pelu-appointment-detail-popup>

    <!-- Global Drag Preview for Cross-Day Dragging -->
    @if (dragPreviewData()) {
      <pelu-calendar-drag-preview [data]="dragPreviewData()!"> </pelu-calendar-drag-preview>
    }
  }
</div>
