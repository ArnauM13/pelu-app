<div class="calendar-container">
  <!-- Loader only on first load -->
  @if (!isBookingsLoaded()) {
    <pelu-calendar-loader />
  }

  <!-- Calendar Content (only show when bookings are loaded) -->
  @else {
    <!-- Calendar Header -->
    <pelu-calendar-header
      [mainTitle]="'Setmana del ' + formatPopupDate(format(viewDate(), 'yyyy-MM-dd'))"
      [viewDateInfo]="getViewDateInfo()"
      [businessDaysInfo]="getBusinessDaysInfo()"
      [canNavigateToPreviousWeek]="canNavigateToPreviousWeek()"
      [currentViewDate]="viewDate()"
      (today)="today()"
      (previousWeek)="previousWeek()"
      (nextWeek)="nextWeek()"
      (dateChange)="onDateChange($event)"
    >
    </pelu-calendar-header>

    <!-- View Mode Controls -->
    <div class="view-mode-controls">
      <div class="view-mode-buttons">
        @for (option of viewModeOptions; track option.value) {
          <pelu-button
            [label]="option.label"
            [icon]="option.icon"
            [severity]="isViewModeActive(option.value) ? 'primary' : 'secondary'"
            [variant]="isViewModeActive(option.value) ? 'filled' : 'outlined'"
            size="small"
            (clicked)="changeViewMode(option.value)"
            [class.active]="isViewModeActive(option.value)"
          >
          </pelu-button>
        }
      </div>
      <div class="view-mode-info">
        <span class="current-view">{{ getCurrentViewModeName() }}</span>
      </div>
    </div>

    <!-- Calendar Body -->
    <div class="calendar-body">

      <!-- Previous Week Button -->
      <pelu-button
        icon="pi pi-chevron-left"
        [disabled]="!canNavigateToPreviousWeek()"
        ariaLabel="COMMON.VIEWS.CALENDAR.PREVIOUS_WEEK"
        size="small"
        severity="secondary"
        variant="outlined"
        class="nav-btn"
        (clicked)="previousWeek()"
      />

      <div class="horizontal-week-view" [style.--calendar-slot-count]="timeSlots().length">
        <!-- Time Column -->
        <pelu-calendar-time-column [timeSlots]="timeColumnSlots()"> </pelu-calendar-time-column>

        <!-- Day Columns Container -->
        <div class="day-columns-container">
          @for (dayColumn of dayColumnsData(); track dayColumn.date; let i = $index) {
            <pelu-calendar-day-column
              [data]="dayColumn"
              (timeSlotClicked)="onTimeSlotClick($event.date, $event.time)"
              (appointmentClicked)="openAppointmentPopup($event)"
              (dropZoneMouseEnter)="onDropZoneMouseEnter($event, dayColumn.date)"
              (dropZoneMouseMove)="onDropZoneMouseMove($event, dayColumn.date)"
              (dropZoneDrop)="onDropZoneDrop($event, dayColumn.date)"
              (dropZoneDragOver)="onDropZoneDragOver($event)"
            >
            </pelu-calendar-day-column>
          }
        </div>
      </div>

      <!-- Next Week Button -->
      <pelu-button
        icon="pi pi-chevron-right"
        ariaLabel="COMMON.VIEWS.CALENDAR.NEXT_WEEK"
        size="small"
        severity="secondary"
        variant="outlined"
        class="nav-btn"
        (clicked)="nextWeek()"
      />

    </div>

    <!-- Date Picker Section -->
    <div class="date-picker-section">
      <pelu-button
        label="Avui"
        icon="pi pi-calendar"
        size="small"
        severity="primary"
        class="today-btn"
        (clicked)="today()"
      />
      <pelu-input-date
        [(ngModel)]="selectedDate"
        [showButtonBar]="true"
        [minDate]="todayDate()"
        (valueChange)="onDateChange($event)"
        placeholder="Selecciona una data"
      />
    </div>

    <!-- Appointment Detail Popup -->
    <pelu-appointment-detail-popup
      [open]="showDetailPopup()"
      [booking]="selectedAppointment()"
      (closed)="onAppointmentDetailPopupClosed()"
      (deleted)="onAppointmentDeleted($event)"
      (editRequested)="onAppointmentEditRequested($event)"
    >
    </pelu-appointment-detail-popup>

    <!-- Global Drag Preview for Cross-Day Dragging -->
    @if (dragPreviewData()) {
      <pelu-calendar-drag-preview [data]="dragPreviewData()!"> </pelu-calendar-drag-preview>
    }
  }
</div>
