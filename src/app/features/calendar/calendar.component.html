<div class="calendar-container">
  <!-- Loader while bookings are loading -->
  @if (isLoading()) {
    <div class="calendar-loader">
      <pelu-loader></pelu-loader>
    </div>
  }

  <!-- Calendar Content (only show when bookings are loaded) -->
  @if (isBookingsLoaded()) {
    <!-- Calendar Header -->
    <pelu-calendar-header
      [mainTitle]="'Setmana del ' + formatPopupDate(format(viewDate(), 'yyyy-MM-dd'))"
      [viewDateInfo]="getViewDateInfo()"
      [businessDaysInfo]="getBusinessDaysInfo()"
      [canNavigateToPreviousWeek]="canNavigateToPreviousWeek()"
      [currentViewDate]="viewDate()"
      (today)="today()"
      (previousWeek)="previousWeek()"
      (nextWeek)="nextWeek()"
      (dateChange)="onDateChange($event)"
    />

    <!-- Calendar Body -->
    <div class="calendar-body">
    <div class="horizontal-week-view" [style.--calendar-slot-count]="timeSlots().length">
      <!-- Time Column -->
      <div class="time-column">
        <div class="time-header">Hora</div>
        @for (time of timeSlots(); track time; let k = $index) {
          <div class="time-slot-label"
               [class.lunch-break]="isTimeSlotBlocked(time)"
               [class.lunch-break-start]="isLunchBreakStart(time)">
            {{ time }}
          </div>
        }
      </div>

      <!-- Day Columns -->
      @for (day of weekDays(); track day; let i = $index) {
        <div class="day-column"
             [class.past]="isPastDate(day)"
             [class.disabled]="isPastDate(day)">
          <div class="day-header">
            <div class="day-name">{{ getDayName(day) }}</div>
            <div class="day-date">{{ format(day, 'dd/MM') }}</div>
          </div>

          <!-- Time Slots Container with relative positioning -->
          <div class="time-slots-container"
               [class.drag-over]="dragDropService.isDragging()"
               [class.drop-valid]="dragDropService.isDragging() && dragDropService.isValidDrop()"
               [class.drop-invalid]="dragDropService.isDragging() && !dragDropService.isValidDrop()"
               (mouseenter)="onDropZoneMouseEnter($event, day)"
               (mousemove)="onDropZoneMouseMove($event, day)"
               (drop)="onDropZoneDrop($event, day)"
               (dragover)="onDropZoneDragOver($event)">
            <!-- Clickable Time Slots -->
            @for (time of timeSlots(); track time; let k = $index) {
              <div class="time-slot"
                   [class.available]="isTimeSlotAvailable(day, time)"
                   [class.booked]="!isTimeSlotAvailable(day, time) && !isTimeSlotBlocked(time) && !isPastDate(day) && !isPastTimeSlot(day, time)"
                   [class.lunch-break]="isTimeSlotBlocked(time)"
                   [class.past-date]="isPastDate(day)"
                   [class.past-time]="isPastTimeSlot(day, time)"
                   [class.clickable]="isTimeSlotAvailable(day, time)"
                   [class.disabled]="isPastDate(day) || isPastTimeSlot(day, time)"
                   [title]="getTimeSlotTooltip(day, time)"
                   (click)="!isPastDate(day) && !isPastTimeSlot(day, time) && selectTimeSlot(day, time)">
              </div>
            }

            <!-- Render Appointments with the new optimized component -->
            @for (appt of getAppointmentsForDay(day); track appt.id + '-' + appt.start) {
              @if (appt && appt.start) {
                <pelu-appointment-slot
                  [data]="createAppointmentSlotData(appt, day)"
                  (clicked)="openAppointmentPopup($event)">
                </pelu-appointment-slot>
              }
            }

            <!-- Drop indicator when dragging -->
            @if (dragDropService.isDragging() && dragDropService.targetDate() && dragDropService.targetTime() && dragDropService.draggedAppointment()) {
              @if (isSameDay(day, dragDropService.targetDate()!)) {
                <div class="drop-indicator"
                     [style.top.px]="dragDropService.calculateGridPosition(dragDropService.draggedAppointment()!, day, dragDropService.targetTime()!).top"
                     [style.height.px]="dragDropService.calculateGridPosition(dragDropService.draggedAppointment()!, day, dragDropService.targetTime()!).height"
                     [class.valid]="dragDropService.isValidDrop()"
                     [class.invalid]="!dragDropService.isValidDrop()">
                </div>
              }
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Appointment Detail Popup -->
  <pelu-appointment-detail-popup
    [open]="showDetailPopup()"
    [booking]="selectedAppointment()"
    (closed)="onAppointmentDetailPopupClosed()"
    (deleted)="onAppointmentDeleted($event)"
    (editRequested)="onAppointmentEditRequested($event)">
  </pelu-appointment-detail-popup>

  <!-- Global Drag Preview for Cross-Day Dragging -->
  @if (dragDropService.isDragging() && dragDropService.draggedAppointment()) {
    <div class="global-drag-preview"
         [style.left.px]="dragDropService.currentPosition()?.left || 0"
         [style.top.px]="dragDropService.currentPosition()?.top || 0">
      <div class="drag-preview-content"
           [ngClass]="getServiceCssClass(dragDropService.draggedAppointment()!)">
        <div class="drag-preview-title">{{ dragDropService.draggedAppointment()!.title }}</div>
        @if (dragDropService.draggedAppointment()!.serviceName) {
          <div class="drag-preview-service">{{ dragDropService.draggedAppointment()!.serviceName }}</div>
        }
        <div class="drag-preview-duration">{{ formatDuration(dragDropService.draggedAppointment()!.duration || 60) }}</div>
      </div>
    </div>
  }
  }
</div>
