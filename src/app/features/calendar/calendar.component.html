<div class="calendar-container">
  <!-- Calendar Header -->
  <div class="calendar-header">
    <div class="calendar-navigation">
      <button class="nav-btn"
              [class.disabled]="!canNavigateToPreviousWeek()"
              [disabled]="!canNavigateToPreviousWeek()"
              (click)="previousWeek()"
              title="Setmana anterior">
        <i class="pi pi-arrow-left"></i>
      </button>
      <button class="nav-btn today-btn" (click)="today()" title="Anar a avui">
        Avui
      </button>
      <button class="nav-btn" (click)="nextWeek()" title="Setmana seg√ºent">
        <i class="pi pi-arrow-right"></i>
      </button>
    </div>
    <div class="calendar-title">
      <div class="title-main">Setmana del {{ formatPopupDate(format(viewDate(), 'yyyy-MM-dd')) }}</div>
      <div class="title-info">{{ getViewDateInfo() }}</div>
      <div class="title-config">{{ getBusinessDaysInfo() }}</div>
    </div>
    <div class="calendar-actions">
      <button class="test-btn"
              (click)="clearAllAppointments()"
              title="Eliminar totes les cites (Test)">
        üóëÔ∏è Netejar Cites
      </button>
    </div>
  </div>

  <!-- Calendar Body -->
  <div class="calendar-body">
    <div class="horizontal-week-view">
      <!-- Time Column -->
      <div class="time-column">
        <div class="time-header">Hora</div>
        @for (time of timeSlots(); track time; let k = $index) {
          <div class="time-slot-label"
               [class.lunch-break]="isLunchBreak(time)"
               [class.lunch-break-start]="isLunchBreakStart(time)">
            {{ time }}
          </div>
        }
      </div>

      <!-- Day Columns -->
      @for (day of weekDays(); track day; let i = $index) {
        <div class="day-column"
             [class.past]="isPastDate(day)">
          <div class="day-header">
            <div class="day-name">{{ getDayName(day) }}</div>
            <div class="day-date">{{ format(day, 'dd/MM') }}</div>
          </div>

          <!-- Time Slots Container with relative positioning -->
          <div class="time-slots-container">
            <!-- Clickable Time Slots -->
            @for (time of timeSlots(); track time; let k = $index) {
              <div class="time-slot"
                   [class.available]="isTimeSlotAvailable(day, time)"
                   [class.booked]="!isTimeSlotAvailable(day, time) && !isLunchBreak(time) && !isPastDate(day) && !isPastTimeSlot(day, time)"
                   [class.lunch-break]="isLunchBreak(time)"
                   [class.past-date]="isPastDate(day)"
                   [class.past-time]="isPastTimeSlot(day, time)"
                   [class.selected]="isTimeSlotSelected(day, time)"
                   [class.clickable]="isTimeSlotAvailable(day, time)"
                   [title]="getTimeSlotTooltip(day, time)"
                   (click)="selectTimeSlot(day, time)">

                              @if (!isTimeSlotAvailable(day, time) && !isLunchBreak(time) && !isPastDate(day) && !isPastTimeSlot(day, time)) {
                <div class="booked-event">
                  Ocupat
                </div>
              }
              </div>
            }

            <!-- Render Appointments with absolute positioning -->
            @for (appt of getAppointmentsForDay(day); track appt.id) {
              <div class="appointment"
                   [style.top.px]="getAppointmentTopPx(appt)"
                   [style.height.px]="getAppointmentHeightPx(appt)"
                   [style.left.px]="0"
                   [style.right.px]="0"
                   (click)="openAppointmentPopup(appt); $event.stopPropagation()">
                <div class="appointment-content">
                  <div class="appointment-title">{{ appt.title }}</div>
                  @if (appt.serviceName) {
                    <div class="appointment-service">{{ appt.serviceName }}</div>
                  }
                  <div class="appointment-duration">{{ formatDuration(appt.duration || 60) }}</div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Appointment Detail Popup -->
  <pelu-appointment-detail-popup
    [open]="showDetailPopup()"
    [appointment]="selectedAppointment()"
    (closed)="onAppointmentDetailPopupClosed()">
  </pelu-appointment-detail-popup>
</div>
