<div class="detail-view-container" [style.view-transition-name]="viewTransitionName" [style.background]="serviceGradient">
  <!-- Loading State -->
  @if (loading) {
    <pelu-loading-state
      [config]="loadingConfig">
    </pelu-loading-state>
  }

  <!-- Not Found State -->
  @if (notFound) {
    <div class="not-found-section">
      <pelu-not-found-state
        [config]="notFoundConfig"
        (onButtonClick)="onBack()">
      </pelu-not-found-state>
    </div>
  }

  <!-- Main Content -->
  @if (!loading && !notFound && (user || appointment)) {
  <div class="detail-view-content" [style.view-transition-name]="contentTransitionName">

    <!-- Header Section -->
    <div class="header-section">
      <!-- Profile Header -->
      @if (type === 'profile' && user) {
      <div class="profile-header">
        <div class="avatar-section">
          <pelu-avatar [data]="avatarData || {}" size="xlarge" class="profile-avatar"></pelu-avatar>
          <div class="user-info">
            <h1 class="user-name">{{ displayName }}</h1>
            <p class="user-email">{{ email }}</p>
          </div>
        </div>
      </div>
      }

      <!-- Appointment Header - Desktop Only -->
      @if (type === 'appointment' && appointment) {
      <div class="appointment-header desktop-only" [style.background]="getAppointmentHeaderGradient()">
        <div class="appointment-content">
          <!-- Back Button -->
          <button class="back-btn-emoji" (click)="onBack()" [title]="'COMMON.ACTIONS.BACK' | translate">
            ‚Üê
          </button>

          <div class="appointment-info">
            <h1 class="appointment-title">
              {{ 'COMMON.TIME.APPOINTMENT_TITLE' | translate: { nom: appointment?.nom, data: formatDate(appointment?.data), hora: formatTime(appointment?.hora) } }}
            </h1>
            <p class="appointment-subtitle">{{ 'APPOINTMENTS.APPOINTMENT_DETAILS' | translate }}</p>
          </div>
          <div class="status-section">
            <pelu-appointment-status-badge
              [appointmentData]="{ date: appointment?.data, time: appointment?.hora }"
              [config]="{ size: 'large', variant: 'default', showIcon: true, showDot: true }">
            </pelu-appointment-status-badge>
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid" [class.editing-mode]="isEditing" [class.full-width]="!hasAvailableActions">
      <!-- Left Column - Information Sections -->
      <div class="info-column">
        <!-- Mobile Back Button -->
        @if (type === 'appointment' && appointment) {
        <div class="mobile-back-section">
          <button class="mobile-back-btn" (click)="onBack()" [title]="'COMMON.ACTIONS.BACK' | translate">
            ‚Üê {{ 'COMMON.ACTIONS.BACK' | translate }}
          </button>
        </div>
        }

        <!-- Status Badge (for appointments) -->
        @if (type === 'appointment' && appointment) {
        <div class="info-section status-section-mobile">
          <div class="status-header">
            <h2>{{ 'APPOINTMENTS.STATUS' | translate }}</h2>
          </div>
          <pelu-appointment-status-badge
            [appointmentData]="{ date: appointment?.data, time: appointment?.hora }"
            [config]="{ size: 'medium', variant: 'default', showIcon: true, showDot: true }">
          </pelu-appointment-status-badge>
        </div>
        }

        <!-- Edit Form (when editing appointments) - IN-PLACE -->
        @if (type === 'appointment' && isEditing && appointment) {
        <div class="info-section edit-section">
          <h2>{{ 'COMMON.ACTIONS.EDIT' | translate }} {{ 'APPOINTMENTS.APPOINTMENT_DETAILS' | translate }}</h2>

          <div class="edit-form">
            <div class="form-grid">
              <!-- Client Name -->
              <div class="form-group">
                <pelu-input-text
                  [config]="{
                    type: 'text',
                    label: 'COMMON.CLIENT_NAME',
                    placeholder: 'COMMON.ENTER_CLIENT_NAME',
                    required: true,
                    showLabel: true
                  }"
                  [value]="editForm.nom"
                  (valueChange)="onUpdateForm('nom', $event)">
                </pelu-input-text>
              </div>

              <!-- Date -->
              <div class="form-group">
                <pelu-input-date
                  [config]="{
                    label: 'COMMON.DATE',
                    required: true,
                    showLabel: true
                  }"
                  [value]="editForm.data"
                  (valueChange)="onUpdateForm('data', $event)">
                </pelu-input-date>
              </div>

              <!-- Time -->
              <div class="form-group">
                <pelu-input-text
                  [config]="{
                    type: 'time',
                    label: 'COMMON.HOURS',
                    showLabel: true
                  }"
                  [value]="editForm.hora"
                  (valueChange)="onUpdateForm('hora', $event)">
                </pelu-input-text>
              </div>

              <!-- Service -->
              <div class="form-group">
                <pelu-input-text
                  [config]="{
                    type: 'text',
                    label: 'COMMON.SERVICE',
                    placeholder: 'COMMON.SERVICE',
                    showLabel: true
                  }"
                  [value]="editForm.servei"
                  (valueChange)="onUpdateForm('servei', $event)">
                </pelu-input-text>
              </div>

              <!-- Service Name -->
              <div class="form-group">
                <pelu-input-text
                  [config]="{
                    type: 'text',
                    label: 'APPOINTMENTS.SERVICE_FULL_NAME',
                    placeholder: 'COMMON.SERVICE',
                    showLabel: true
                  }"
                  [value]="editForm.serviceName"
                  (valueChange)="onUpdateForm('serviceName', $event)">
                </pelu-input-text>
              </div>

              <!-- Duration -->
              <div class="form-group">
                <pelu-input-number
                  [config]="{
                    label: 'APPOINTMENTS.DURATION_MINUTES',
                    placeholder: '60',
                    min: 15,
                    step: 15,
                    showLabel: true
                  }"
                  [value]="editForm.duration"
                  (valueChange)="onUpdateForm('duration', $event)">
                </pelu-input-number>
              </div>

              <!-- Price -->
              <div class="form-group">
                <pelu-input-number
                  [config]="{
                    label: 'APPOINTMENTS.PRICE_EURO',
                    placeholder: '0',
                    min: 0,
                    step: 0.01,
                    showLabel: true
                  }"
                  [value]="editForm.preu"
                  (valueChange)="onUpdateForm('preu', $event)">
                </pelu-input-number>
              </div>

              <!-- Notes -->
              <div class="form-group full-width">
                <pelu-input-textarea
                  [config]="{
                    label: 'APPOINTMENTS.NOTES',
                    placeholder: 'APPOINTMENTS.NOTES',
                    rows: 3,
                    showLabel: true
                  }"
                  [value]="editForm.notes"
                  (valueChange)="onUpdateForm('notes', $event)">
                </pelu-input-textarea>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button
                class="action-btn secondary"
                (click)="onCancelEdit()">
                <i class="action-icon">‚ùå</i>
                {{ 'COMMON.ACTIONS.CANCEL' | translate }}
              </button>
              <button
                class="action-btn primary"
                (click)="onSave()"
                [disabled]="!canSave || !hasChanges">
                <i class="action-icon">üíæ</i>
                {{ 'COMMON.ACTIONS.SAVE' | translate }}
              </button>
            </div>
          </div>
        </div>
        }

        <!-- Information Sections (only show when NOT editing) -->
        @if (!isEditing) {
          @for (section of infoSections; track section.title; let i = $index) {
          <div class="info-section">
            <div class="section-header">
              <h2>{{ section.title | translate }}</h2>
              @if (section.onEdit && !section.isEditing) {
                <button class="edit-section-btn" (click)="section.onEdit()" [title]="'COMMON.ACTIONS.EDIT' | translate">
                  <i class="edit-icon">‚úèÔ∏è</i>
                </button>
              }
            </div>

            @if (section.isEditing) {
              <div class="edit-notes-form">
                <div class="notes-form-grid">
                  @for (item of section.items; track item.label; let j = $index) {
                    <div class="form-group">
                      <pelu-input-textarea
                        [config]="{
                          label: item.label,
                          placeholder: item.label,
                          rows: 2,
                          showLabel: true
                        }"
                        [value]="item.value"
                        (valueChange)="onUpdateNote(j, $event)">
                      </pelu-input-textarea>
                    </div>
                  }
                </div>

                <div class="form-actions">
                  <button
                    class="action-btn secondary"
                    (click)="section.onCancel?.()">
                    <i class="action-icon">‚ùå</i>
                    {{ 'COMMON.ACTIONS.CANCEL' | translate }}
                  </button>
                  <button
                    class="action-btn primary"
                    (click)="onSaveNotes(section)">
                    <i class="action-icon">üíæ</i>
                    {{ 'COMMON.ACTIONS.SAVE' | translate }}
                  </button>
                </div>
              </div>
            } @else {
              <div class="info-grid">
                @for (item of section.items; track item.label; let j = $index) {
                <pelu-info-item
                  [data]="item"
                  [showStatus]="item.status === 'active'" />
                }
              </div>
            }
          </div>
          }
        }
      </div>

      <!-- Right Column - Actions -->
      @if (hasAvailableActions) {
      <div class="actions-column">
        <div class="actions-section">
          <h2>{{ 'COMMON.ACTIONS.ACTIONS' | translate }}</h2>

          <!-- Action Buttons Section (for appointments) -->
          @if (hasAppointmentActions) {
          <div class="appointment-actions-section">
            @if (canEditAppointment()) {
            <div class="action-item edit-action">
              <div class="action-icon">‚úèÔ∏è</div>
              <div class="action-content">
                <h3>{{ 'COMMON.ACTIONS.EDIT' | translate }}</h3>
                <p>{{ 'APPOINTMENTS.EDIT_APPOINTMENT_DESCRIPTION' | translate }}</p>
              </div>
              <button
                class="action-btn-small edit-btn"
                (click)="onEdit()"
                [title]="'COMMON.ACTIONS.EDIT' | translate">
                ‚Üí
              </button>
            </div>
            }
            @if (canDeleteAppointment()) {
            <div class="action-item delete-action">
              <div class="action-icon">üóëÔ∏è</div>
              <div class="action-content">
                <h3>{{ 'COMMON.ACTIONS.DELETE' | translate }}</h3>
                <p>{{ 'APPOINTMENTS.DELETE_APPOINTMENT_DESCRIPTION' | translate }}</p>
              </div>
              <button
                class="action-btn-small delete-btn"
                (click)="onDelete()"
                [title]="'COMMON.ACTIONS.DELETE' | translate">
                ‚Üí
              </button>
            </div>
            }
          </div>
          }

          <!-- General Actions Grid -->
          @if (hasGeneralActions) {
          <div class="actions-grid">
            @for (action of filteredActions; track action.label; let k = $index) {
            @if (action.label !== 'COMMON.ACTIONS.EDIT' && action.label !== 'COMMON.ACTIONS.DELETE') {
            <button
              class="action-btn"
              [class]="action.type || 'secondary'"
              (click)="action.onClick()"
              [disabled]="action.disabled"
              *ngIf="!action.routerLink"
            >
              <i class="action-icon">{{ action.icon }}</i>
              {{ action.label | translate }}
            </button>
            <a *ngIf="action.routerLink" [routerLink]="action.routerLink" class="action-btn" [class]="action.type || 'secondary'">
              <i class="action-icon">{{ action.icon }}</i>
              {{ action.label | translate }}
            </a>
            }
            }
          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>
  }
</div>
