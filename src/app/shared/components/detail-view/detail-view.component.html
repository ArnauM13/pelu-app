<div
  class="detail-view-container"
  [style.view-transition-name]="viewTransitionName()"
>
  <!-- Loading State -->
  @if (isLoading()) {
    <pelu-loading-state [config]="loadingConfig()"> </pelu-loading-state>
  }

  <!-- Not Found State -->
  @if (notFound()) {
    <div class="not-found-section">
      <pelu-not-found-state [config]="notFoundConfig()" (buttonClick)="onBack()">
      </pelu-not-found-state>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading() && !notFound() && (user() || appointment())) {
    <div class="detail-view-content" [style.view-transition-name]="contentTransitionName()">
      <!-- Mobile Header for Appointments -->
      @if (type() === 'appointment' && appointment()) {
        <div class="mobile-appointment-header">
          <pelu-button
            label="←"
            [ariaLabel]="'COMMON.ACTIONS.BACK' | translate"
            variant="text"
            severity="contrast"
            [rounded]="true"
            class="mobile-back-btn"
            (clicked)="onBack()"
          >
          </pelu-button>

          <div class="mobile-client-info">
            <pelu-avatar
              [data]="appointmentClientAvatarData() || {}"
              size="medium"
              class="mobile-client-avatar"
            ></pelu-avatar>
            <div class="mobile-client-details">
              <span class="mobile-client-name">{{ appointmentTitle() }}</span>
              <span class="mobile-client-subtitle">{{ appointmentSubtitle() }}</span>
            </div>
          </div>

          <pelu-appointment-status-badge
            [appointmentData]="{ date: appointment()?.data || '', time: appointment()?.hora || '' }"
            [config]="{ size: 'medium', variant: 'default', showIcon: true, showDot: true }"
            class="mobile-status-badge"
          >
          </pelu-appointment-status-badge>
        </div>
      }

      <!-- Header Section -->
      <div class="header-section">
        <!-- Profile Header -->
        @if (type() === 'profile' && user()) {
          <div class="profile-header">
            <div class="avatar-section">
              <pelu-avatar
                [data]="avatarData() || {}"
                size="xlarge"
                class="profile-avatar"
              ></pelu-avatar>
              <div class="user-info">
                <h1 class="user-name">{{ displayName() }}</h1>
                <p class="user-email">{{ email() }}</p>
              </div>
            </div>
          </div>
        }

        <!-- Appointment Header - Desktop Only -->
        @if (type() === 'appointment' && appointment()) {
          <div
            class="appointment-header desktop-only"
            [style.background]="appointmentHeaderGradient()"
          >
            <div class="appointment-content">
              <!-- Back Button -->
              <pelu-button
                label="←"
                [ariaLabel]="'COMMON.ACTIONS.BACK' | translate"
                variant="text"
                severity="contrast"
                [rounded]="true"
                class="back-btn-emoji"
                (clicked)="onBack()"
              >
              </pelu-button>

              <div class="appointment-info">
                <div class="client-info-section">
                  <pelu-avatar
                    [data]="appointmentClientAvatarData() || {}"
                    size="large"
                    class="client-avatar"
                  ></pelu-avatar>
                  <div class="client-details">
                    <h1 class="appointment-title">{{ appointmentTitle() }}</h1>
                    <p class="appointment-subtitle">{{ appointmentSubtitle() }}</p>
                  </div>
                </div>
              </div>
              <div class="status-section">
                <pelu-appointment-status-badge
                  [appointmentData]="{ date: appointment()?.data || '', time: appointment()?.hora || '' }"
                  [config]="{ size: 'large', variant: 'default', showIcon: true, showDot: true }"
                >
                </pelu-appointment-status-badge>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Card Content -->
      <div class="card-content">
        @if (type() === 'appointment' && appointment()) {
          <!-- Appointment Detail Layout -->
          <div class="appointment-detail-layout">
                         <!-- Appointment Details Section (30% width) -->
             <div class="appointment-details-section">
               <div class="appointment-details-card">
                 <div class="section-header">
                   <h2>{{ 'APPOINTMENTS.APPOINTMENT_DETAILS' | translate }}</h2>
                   @if (hasAvailableActions() && !isEditing() && actionContext()) {
                     <pelu-actions-buttons [context]="actionContext()!"> </pelu-actions-buttons>
                   }
                 </div>

              @if (isEditing()) {
                <!-- Edit Form -->
                <div class="edit-form">
                  <div class="form-grid">
                    <!-- Client Name - EDITABLE -->
                    <div class="form-group">
                      <pelu-input-text
                        [label]="'COMMON.CLIENT_NAME'"
                        [placeholder]="'COMMON.ENTER_CLIENT_NAME'"
                        [required]="true"
                        [value]="appointment()?.clientName || ''"
                        (valueChange)="onUpdateForm('clientName', $event)"
                      >
                      </pelu-input-text>
                    </div>

                    <!-- Date - EDITABLE -->
                    <div class="form-group">
                      <pelu-input-date
                        [label]="'COMMON.DATE'"
                        [required]="true"
                        [value]="appointment()?.data || ''"
                        (valueChange)="onUpdateForm('data', $event)"
                      >
                      </pelu-input-date>
                    </div>

                    <!-- Time - EDITABLE -->
                    <div class="form-group">
                      <pelu-input-text
                        [label]="'COMMON.HOURS'"
                        [placeholder]="'HH:MM'"
                        [required]="true"
                        [value]="appointment()?.hora || ''"
                        (valueChange)="onUpdateForm('hora', $event)"
                      >
                      </pelu-input-text>
                    </div>

                    <!-- Notes - EDITABLE -->
                    <div class="form-group">
                      <pelu-input-textarea
                        [label]="'COMMON.NOTES'"
                        [placeholder]="'COMMON.NOTES'"
                        [value]="appointment()?.notes || ''"
                        [rows]="3"
                        (valueChange)="onUpdateForm('notes', $event)"
                      >
                      </pelu-input-textarea>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="form-actions">
                    <pelu-button
                      [label]="'COMMON.ACTIONS.CANCEL'"
                      severity="danger"
                      (clicked)="onCancelEdit()"
                    />
                    <pelu-button
                      [label]="'COMMON.ACTIONS.SAVE'"
                      severity="primary"
                      (clicked)="onSave()"
                    />
                  </div>
                </div>
              } @else {
                <!-- View Mode -->
                <div class="appointment-info-grid">
                  <div class="form-group">
                    <pelu-input-text
                      [label]="'COMMON.CLIENT'"
                      [value]="appointment()?.clientName || 'N/A'"
                      [readonly]="true"
                      [disabled]="true"
                    >
                    </pelu-input-text>
                  </div>

                  <div class="form-group">
                    <pelu-input-text
                      [label]="'COMMON.DATE'"
                      [value]="appointment()?.data ? formatDate(appointment()!.data) : 'N/A'"
                      [readonly]="true"
                      [disabled]="true"
                    >
                    </pelu-input-text>
                  </div>

                  <div class="form-group">
                    <pelu-input-text
                      [label]="'COMMON.HOURS'"
                      [value]="appointment()?.hora || 'N/A'"
                      [readonly]="true"
                      [disabled]="true"
                    >
                    </pelu-input-text>
                  </div>

                  <div class="form-group">
                    <pelu-input-textarea
                      [label]="'COMMON.NOTES'"
                      [value]="appointment()?.notes || 'N/A'"
                      [readonly]="true"
                      [disabled]="true"
                      [rows]="3"
                    >
                    </pelu-input-textarea>
                  </div>
                </div>
              }
            </div>
            </div>

            <!-- Service and ICS Section -->
            <div class="service-and-ics-section">
              <!-- Service Information Section -->
              <div class="service-info-section">
                @if (service()) {
                  <pelu-service-card
                    [service]="service()!"
                    [showCategory]="false"
                    [showActions]="false"
                    [clickable]="false"
                  >
                  </pelu-service-card>
                } @else {
                  <div class="no-service-info">
                    <p>{{ 'COMMON.NO_SPECIFIED' | translate }}</p>
                  </div>
                }
              </div>

              <!-- Download ICS Section -->
              <div class="ics-section">
                <pelu-card variant="default">
                  <div class="summary-section">
                    <h3>📅 {{ 'BOOKING.DOWNLOAD_CALENDAR' | translate }}</h3>
                    <p class="ics-description">{{ 'BOOKING.DOWNLOAD_CALENDAR_DESCRIPTION' | translate }}</p>
                    <pelu-button
                      [label]="'BOOKING.DOWNLOAD_ICS'"
                      [icon]="'pi pi-download'"
                      iconPos="left"
                      (clicked)="downloadIcsFile()"
                      severity="secondary"
                      variant="outlined"
                      [fluid]="true"
                    >
                    </pelu-button>
                  </div>
                </pelu-card>
              </div>
            </div>
          </div>
        } @else {
          <!-- Information Sections (for other types) -->
          @if (!isEditing()) {
            @for (section of infoSections(); track section.title; let i = $index) {
              <div class="info-section">
                <div class="section-header">
                  <h2>{{ section.title | translate }}</h2>
                  @if (i === 0 && hasAvailableActions() && !isEditing() && actionContext()) {
                    <pelu-actions-buttons [context]="actionContext()!"> </pelu-actions-buttons>
                  }
                </div>

                @if (section.isEditing) {
                  <div class="edit-notes-form">
                    <div class="notes-form-grid">
                      @for (item of section.items; track item.label; let j = $index) {
                        <div class="form-group">
                          <pelu-input-textarea
                            [label]="item.label"
                            [placeholder]="item.label"
                            [rows]="2"
                            [value]="item.value"
                            (valueChange)="onUpdateForm(item.field || '', $event)"
                          >
                          </pelu-input-textarea>
                        </div>
                      }
                    </div>

                    <div class="form-actions">
                      <pelu-button
                        [label]="'COMMON.ACTIONS.CANCEL' | translate"
                        icon="❌"
                        severity="danger"
                        (clicked)="section.onCancel?.()"
                      >
                      </pelu-button>
                      <pelu-button
                        [label]="'COMMON.ACTIONS.SAVE' | translate"
                        icon="💾"
                        severity="primary"
                        (clicked)="section.onSave?.({})"
                      >
                      </pelu-button>
                    </div>
                  </div>
                } @else {
                  <div class="info-grid">
                    @for (item of section.items; track item.label; let j = $index) {
                      @if (item.field === 'notes') {
                        <div class="form-group full-width">
                          <pelu-input-textarea
                            [label]="item.label"
                            [value]="item.value"
                            [readonly]="true"
                            [disabled]="true"
                            [rows]="3"
                          >
                          </pelu-input-textarea>
                        </div>
                      } @else {
                        <div class="form-group">
                          <pelu-input-text
                            [label]="item.label"
                            [value]="item.value"
                            [readonly]="true"
                            [disabled]="true"
                          >
                          </pelu-input-text>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }
          }
        }
      </div>
    </div>
  }
</div>
