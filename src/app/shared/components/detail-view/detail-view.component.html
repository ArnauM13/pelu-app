<div
  class="detail-view-container"
  [style.view-transition-name]="viewTransitionName()"
>
  <!-- Loading State -->
  @if (isLoading()) {
    <pelu-loading-state [config]="loadingConfig()"> </pelu-loading-state>
  }

  <!-- Not Found State -->
  @if (notFound()) {
    <div class="not-found-section">
      <pelu-not-found-state [config]="notFoundConfig()" (buttonClick)="onBack()">
      </pelu-not-found-state>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading() && !notFound() && (user() || appointment())) {
    <div class="detail-view-content" [style.view-transition-name]="contentTransitionName()">
      <!-- Mobile Header for Appointments -->
      @if (type() === 'appointment' && appointment()) {
        <div class="mobile-appointment-header">
          <pelu-button
            label="←"
            [ariaLabel]="'COMMON.ACTIONS.BACK' | translate"
            variant="text"
            severity="contrast"
            [rounded]="true"
            class="mobile-back-btn"
            (clicked)="onBack()"
          >
          </pelu-button>

          <pelu-appointment-status-badge
            [appointmentData]="{ date: appointment()?.data || '', time: appointment()?.hora || '' }"
            [config]="{ size: 'medium', variant: 'default', showIcon: true, showDot: true }"
            class="mobile-status-badge"
          >
          </pelu-appointment-status-badge>
        </div>
      }

      <!-- Header Section -->
      <div class="header-section">
        <!-- Profile Header -->
        @if (type() === 'profile' && user()) {
          <div class="profile-header">
            <div class="avatar-section">
              <pelu-avatar
                [data]="avatarData() || {}"
                size="xlarge"
                class="profile-avatar"
              ></pelu-avatar>
              <div class="user-info">
                <h1 class="user-name">{{ displayName() }}</h1>
                <p class="user-email">{{ email() }}</p>
              </div>
            </div>
          </div>
        }

        <!-- Appointment Header - Desktop Only -->
        @if (type() === 'appointment' && appointment()) {
          <div
            class="appointment-header desktop-only"
            [style.background]="appointmentHeaderGradient()"
          >
            <div class="appointment-content">
              <!-- Back Button -->
              <pelu-button
                label="←"
                [ariaLabel]="'COMMON.ACTIONS.BACK' | translate"
                variant="text"
                severity="contrast"
                [rounded]="true"
                class="back-btn-emoji"
                (clicked)="onBack()"
              >
              </pelu-button>

              <div class="appointment-info">
                <h1 class="appointment-title">
                  {{
                    'COMMON.TIME.APPOINTMENT_TITLE'
                      | translate
                        : {
                            nom: appointment()?.clientName,
                            data: formatDate(appointment()?.data || ''),
                            hora: formatTime(appointment()?.hora || ''),
                          }
                  }}
                </h1>
                <p class="appointment-subtitle">
                  {{ 'APPOINTMENTS.APPOINTMENT_DETAILS' | translate }}
                </p>
              </div>
              <div class="status-section">
                <pelu-appointment-status-badge
                  [appointmentData]="{ date: appointment()?.data || '', time: appointment()?.hora || '' }"
                  [config]="{ size: 'large', variant: 'default', showIcon: true, showDot: true }"
                >
                </pelu-appointment-status-badge>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Card Content -->
      <div class="card-content">
        <!-- Edit Form (when editing appointments) - IN-PLACE -->
        @if (type() === 'appointment' && isEditing() && appointment()) {
          <div class="info-section edit-section">
            <h2>
              {{ 'APPOINTMENTS.EDIT_APPOINTMENT_DETAILS' | translate }}
            </h2>

            <div class="edit-form">
              <div class="form-grid">
                <!-- Client Name - EDITABLE -->
                <div class="form-group">
                  <pelu-input-text
                    [label]="'COMMON.CLIENT_NAME'"
                    [placeholder]="'COMMON.ENTER_CLIENT_NAME'"
                    [required]="true"
                    [value]="appointment()?.clientName || ''"
                    (valueChange)="onUpdateForm('clientName', $event)"
                  >
                  </pelu-input-text>
                </div>

                <!-- Date - EDITABLE -->
                <div class="form-group">
                  <pelu-input-date
                    [label]="'COMMON.DATE'"
                    [required]="true"
                    [value]="appointment()?.data || ''"
                    (valueChange)="onUpdateForm('data', $event)"
                  >
                  </pelu-input-date>
                </div>

                <!-- Time - EDITABLE -->
                <div class="form-group">
                  <pelu-input-text
                    [label]="'COMMON.TIME.HOURS'"
                    [placeholder]="'HH:MM'"
                    [required]="true"
                    [value]="appointment()?.hora || ''"
                    (valueChange)="onUpdateForm('hora', $event)"
                  >
                  </pelu-input-text>
                </div>

                <!-- Notes - EDITABLE -->
                <div class="form-group full-width">
                  <pelu-input-textarea
                    [label]="'COMMON.NOTES'"
                    [placeholder]="'COMMON.NOTES'"
                    [value]="appointment()?.notes || ''"
                    [rows]="3"
                    (valueChange)="onUpdateForm('notes', $event)"
                  >
                  </pelu-input-textarea>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="form-actions">
                <pelu-button
                  [label]="'COMMON.ACTIONS.CANCEL'"
                  severity="secondary"
                  (clicked)="onCancelEdit()"
                />
                <pelu-button
                  [label]="'COMMON.ACTIONS.SAVE'"
                  severity="primary"
                  (clicked)="onSave()"
                />
              </div>
            </div>
          </div>
        }

        <!-- Information Sections (only show when NOT editing) -->
        @if (!isEditing()) {
          @for (section of infoSections(); track section.title; let i = $index) {
            <div class="info-section">
              <div class="section-header">
                <h2>{{ section.title | translate }}</h2>
                @if (i === 0 && hasAvailableActions() && !isEditing() && actionContext()) {
                  <pelu-actions-buttons [context]="actionContext()!"> </pelu-actions-buttons>
                }
              </div>

              @if (section.isEditing) {
                <div class="edit-notes-form">
                  <div class="notes-form-grid">
                    @for (item of section.items; track item.label; let j = $index) {
                      <div class="form-group">
                        <pelu-input-textarea
                          [label]="item.label"
                          [placeholder]="item.label"
                          [rows]="2"
                          [value]="item.value"
                          (valueChange)="onUpdateForm(item.field || '', $event)"
                        >
                        </pelu-input-textarea>
                      </div>
                    }
                  </div>

                  <div class="form-actions">
                    <pelu-button
                      [label]="'COMMON.ACTIONS.CANCEL' | translate"
                      icon="❌"
                      severity="secondary"
                      (clicked)="section.onCancel?.()"
                    >
                    </pelu-button>
                    <pelu-button
                      [label]="'COMMON.ACTIONS.SAVE' | translate"
                      icon="💾"
                      severity="primary"
                      (clicked)="section.onSave?.({})"
                    >
                    </pelu-button>
                  </div>
                </div>
              } @else {
                <div class="info-grid">
                  @for (item of section.items; track item.label; let j = $index) {
                    <pelu-info-item [data]="item" [showStatus]="false" />
                  }
                </div>
              }
            </div>
          }
        }
      </div>
    </div>
  }
</div>
