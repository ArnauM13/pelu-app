@if (open()) {
<div class="booking-popup-overlay" (click)="onBackdropClick($event)">
  <div class="booking-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h3>{{ 'COMMON.ACTIONS.CONFIRM_BOOKING' | translate }}</h3>
      <button class="close-btn" (click)="onClose()">×</button>
    </div>

    <div class="popup-body">
      <!-- Date and Time Display (Read-only) -->
      <div class="form-group">
        <label>{{ 'COMMON.DATE' | translate }}:</label>
        <div class="readonly-field">{{ formatDate(bookingDetails().date) }}</div>
      </div>
      <div class="form-group">
        <label>{{ 'COMMON.HOURS' | translate }}:</label>
        <div class="readonly-field">{{ bookingDetails().time }}</div>
      </div>

      <!-- Service Display (Mobile only - Read-only) -->
      <div class="form-group mobile-only" *ngIf="bookingDetails().service">
        <label>{{ 'COMMON.SERVICE' | translate }}:</label>
        <div class="service-display-mobile">
          <div class="service-info-mobile">
            <div class="service-icon-mobile">{{ bookingDetails().service!.icon }}</div>
            <div class="service-details-mobile">
              <span class="service-name-mobile">{{ getServiceName(bookingDetails().service!) }}</span>
              <span class="service-duration-mobile">{{ bookingDetails().service!.duration }} {{ 'COMMON.UNITS.MINUTES' | translate }}</span>
              <span class="service-price-mobile">{{ formatPrice(bookingDetails().service!.price) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Service Selection/Display (Desktop only) -->
      <div class="form-group desktop-only">
        <label>{{ 'COMMON.SERVICE' | translate }}:</label>
        <div class="service-selection">
          @if (bookingDetails().service) {
            <div class="selected-service">
              <div class="service-info">
                <span class="service-icon">{{ bookingDetails().service!.icon }}</span>
                <div class="service-details">
                  <div class="service-name">{{ getServiceName(bookingDetails().service!) }}</div>
                  <div class="service-description">{{ bookingDetails().service!.description }}</div>
                  <div class="service-meta">
                    <span class="service-duration">{{ formatDuration(bookingDetails().service!.duration) }}</span>
                    @if (bookingDetails().service!.popular) {
                      <span class="service-popular">⭐ Popular</span>
                    }
                  </div>
                </div>
              </div>
              <div class="service-price">{{ formatPrice(bookingDetails().service!.price) }}</div>
            </div>
          } @else {
            <p-select
              [options]="availableServices()"
              [(ngModel)]="selectedService"
              (onChange)="onServiceChange($event)"
              optionLabel="name"
              placeholder="{{ 'COMMON.SELECTION.SELECT_SERVICE' | translate }}"
              class="service-select">
              <ng-template pTemplate="item" let-service>
                <div class="service-option">
                  <span class="service-icon">{{ service.icon }}</span>
                  <div class="service-info">
                    <div class="service-name">{{ getServiceName(service) }}</div>
                    <div class="service-description">{{ service.description }}</div>
                    <div class="service-meta">
                      <span class="service-duration">{{ formatDuration(service.duration) }}</span>
                      @if (service.popular) {
                        <span class="service-popular">⭐ Popular</span>
                      }
                    </div>
                  </div>
                </div>
                <div class="service-details">
                  <div class="service-price">{{ formatPrice(service.price) }}</div>
                </div>
              </ng-template>
            </p-select>
          }
        </div>
      </div>

      <!-- Client Name Input -->
      <div class="form-group">
        <label>{{ 'COMMON.CLIENT_NAME' | translate }}:</label>
        @if (isAuthenticated()) {
          <div class="readonly-field">{{ currentUserName() }}</div>
        } @else {
          <input
            type="text"
            class="form-input"
            [value]="clientName() || bookingDetails().clientName"
            (input)="updateClientName($any($event.target).value)"
            [placeholder]="'COMMON.ENTER_CLIENT_NAME' | translate">
        }
      </div>

      <!-- Email Input (Always required) -->
      <div class="form-group">
        <label>{{ 'COMMON.EMAIL' | translate }}: <span class="required">*</span></label>
        @if (isAuthenticated()) {
          <div class="readonly-field">{{ currentUserEmail() }}</div>
        } @else {
          <input
            type="email"
            class="form-input"
            [value]="email() || bookingDetails().email"
            (input)="updateEmail($any($event.target).value)"
            [placeholder]="'COMMON.ENTER_EMAIL' | translate"
            [class.invalid]="email() && !isValidEmail(email())">
          @if (email() && !isValidEmail(email())) {
            <div class="error-message">{{ 'COMMON.VALIDATION.INVALID_EMAIL' | translate }}</div>
          }
        }
      </div>

      <!-- Total Price Display -->
      <div class="form-group total-price">
        <label>{{ 'COMMON.TOTAL_PRICE' | translate }}:</label>
        <div class="price-display">{{ formatPrice(totalPrice()) }}</div>
      </div>

    </div>

    <div class="popup-footer">
      <button class="btn-secondary" (click)="onClose()">
        {{ 'COMMON.ACTIONS.CANCEL' | translate }}
      </button>
      <button class="btn-primary" (click)="onConfirm()" [disabled]="!canConfirm()">
        {{ 'COMMON.ACTIONS.CONFIRM' | translate }}
      </button>
    </div>
  </div>
</div>
}
