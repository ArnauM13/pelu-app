<p-toast></p-toast>

<div class="container">
  <!-- Bot√≥ de men√∫ lateral (filtres) a dalt a l'esquerra -->
  <div class="menu-filters-fab" *ngIf="popupStack().length === 0">
    <pelu-floating-button
      [config]="{ icon: '‚ò∞', tooltip: 'COMMON.FILTERS' | translate, ariaLabel: 'COMMON.OPEN_FILTERS' | translate, variant: 'primary', size: 'large', isActive: popupStack().length > 0 }"
      (clicked)="openFiltersPopup()">
    </pelu-floating-button>
  </div>

  <!-- Popup Stack -->
  <pelu-popup-stack
    [popups]="popupStack()"
    (popupClosed)="closePopup($event)">
  </pelu-popup-stack>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-content">
        <div class="stat-number">{{ totalAppointments() }}</div>
        <div class="stat-label">{{ 'COMMON.TOTAL_APPOINTMENTS' | translate }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üéØ</div>
      <div class="stat-content">
        <div class="stat-number">{{ todayAppointments() }}</div>
        <div class="stat-label">{{ 'COMMON.TODAY_APPOINTMENTS' | translate }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">‚è∞</div>
      <div class="stat-content">
        <div class="stat-number">{{ upcomingAppointments() }}</div>
        <div class="stat-label">{{ 'COMMON.UPCOMING_APPOINTMENTS' | translate }}</div>
      </div>
    </div>
  </div>

  <!-- View Mode Toggle (main action - right side) -->
  <div class="view-toggle-fab" role="group" [attr.aria-label]="'COMMON.CHANGE_VIEW' | translate">
    @for (button of viewButtons(); track button.icon; let i = $index) {
    <pelu-floating-button
      [config]="button"
      (clicked)="onViewButtonClick(i)">
    </pelu-floating-button>
    }
  </div>

  <!-- Calendar View -->
  @if (viewMode() === 'calendar') {
  <pelu-card variant="large">
    <div class="card-header">
      <h3>üìÖ {{ 'COMMON.APPOINTMENTS_CALENDAR' | translate }}</h3>
      <p class="calendar-subtitle">{{ 'COMMON.VIEW_APPOINTMENTS' | translate }}</p>
    </div>

    <div class="calendar-container">
      <p-calendar
        [(ngModel)]="selectedDate"
        (onSelect)="onDateSelect($event)"
        [inline]="true"
        [showOtherMonths]="true"
        [selectOtherMonths]="false"
        [firstDayOfWeek]="1"
        dateFormat="dd/mm/yy"
        [showIcon]="false">

        <ng-template pTemplate="date" let-date>
          <div class="calendar-day" [class.has-appointments]="getAppointmentsForDate(date).length > 0">
            <span class="day-number">{{ date.day }}</span>
            @if (getAppointmentsForDate(date).length > 0) {
            <div class="appointment-indicators">
              @for (appointment of getAppointmentsForDate(date); track appointment.id) {
              <div
                class="appointment-dot"
                [style.background-color]="getEventColor(appointment.data)"
                [pTooltip]="appointment.nom + ' - ' + formatTime(appointment.hora)">
              </div>
              }
            </div>
            }
          </div>
        </ng-template>
      </p-calendar>
    </div>

    <!-- Mostra la llista de cites o el missatge d'instrucci√≥ a sota del calendari -->
    @if (selectedDate()) {
    <div class="selected-date-appointments">
      <h4>üìã {{ 'COMMON.APPOINTMENTS_FOR_DATE' | translate }} {{ formatDate(formatDateForDisplay(selectedDate()!)) }}</h4>
      @if (getAppointmentsForDate(selectedDate()!).length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üìÖ</div>
        <h3>{{ 'COMMON.NO_SCHEDULED_APPOINTMENTS' | translate }}</h3>
        <p>{{ 'COMMON.NO_APPOINTMENTS_MESSAGE' | translate }}</p>
      </div>
      } @else {
      <div class="appointments-list">
        @for (cita of getAppointmentsForDate(selectedDate()!); track cita.id) {
        <div class="appointment-item" [class.today]="isToday(cita.data)">
          <!-- Informaci√≥ de la cita (esquerra) -->
          <div class="appointment-info">
            <div class="client-info">
              <h4 class="client-name">{{ cita.nom }}</h4>
              <div class="appointment-details">
                @if (cita.hora) {
                <div class="detail-item">
                  <span class="detail-icon">‚è∞</span>
                  <span class="detail-text">{{ formatTime(cita.hora) }}</span>
                </div>
                }
              </div>
            </div>
          </div>

          <!-- Status i accions (dreta) -->
          <div class="appointment-actions-container">
            <div class="appointment-status">
              @if (isToday(cita.data)) {
              <span class="status-badge today">{{ 'COMMON.TODAY' | translate }}</span>
              }
            </div>

            <div class="appointment-actions">
              <button
                class="btn btn-danger"
                (click)="deleteAppointment(cita)"
                [pTooltip]="'COMMON.DELETE_CONFIRMATION' | translate"
                pTooltipPosition="left">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }
    </div>
    } @else {
    <div class="calendar-instructions">
      <div class="instruction-content">
        <div class="instruction-icon">üëÜ</div>
        <h4>{{ 'COMMON.SELECT_DATE' | translate }}</h4>
        <p>{{ 'COMMON.SELECT_DATE_INSTRUCTIONS' | translate }}</p>
      </div>
    </div>
    }
  </pelu-card>
  }

  <!-- Appointments List View -->
  @if (viewMode() === 'list') {
  <pelu-card variant="large">
    <div class="card-header">
      <h3>{{ 'COMMON.APPOINTMENTS_LIST' | translate }} ({{ filteredCites().length }})</h3>
    </div>

    @if (filteredCites().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üìÖ</div>
      <h3>{{ 'COMMON.NO_APPOINTMENTS' | translate }}</h3>
      <p>{{ filterDate() || filterClient() ? ('COMMON.NO_APPOINTMENTS_FILTERED' | translate) : ('COMMON.NO_APPOINTMENTS_SCHEDULED' | translate) }}</p>
      @if (filterDate() || filterClient()) {
      <button class="btn btn-primary" (click)="clearFilters()">
        {{ 'COMMON.CLEAR_FILTERS' | translate }}
      </button>
      }
    </div>
    } @else {
    <div class="appointments-list">
      @for (cita of filteredCites(); track cita.id) {
      <div class="appointment-item" [class.today]="isToday(cita.data)" [class.past]="isPast(cita.data)">
        <!-- Informaci√≥ de la cita (esquerra) -->
        <div class="appointment-info">
          <div class="client-info">
            <h4 class="client-name">{{ cita.nom }}</h4>
            <div class="appointment-details">
              <div class="detail-item">
                <span class="detail-icon">üìÖ</span>
                <span class="detail-text">{{ formatDate(cita.data) }}</span>
              </div>

              @if (cita.hora) {
              <div class="detail-item">
                <span class="detail-icon">‚è∞</span>
                <span class="detail-text">{{ formatTime(cita.hora) }}</span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Status i accions (dreta) -->
        <div class="appointment-actions-container">
          <div class="appointment-status">
            @if (isToday(cita.data)) {
            <span class="status-badge today">{{ 'COMMON.TODAY' | translate }}</span>
            } @else if (isPast(cita.data)) {
            <span class="status-badge past">{{ 'COMMON.PAST' | translate }}</span>
            }
          </div>

          <div class="appointment-actions">
            <button
              class="btn btn-danger"
              (click)="deleteAppointment(cita)"
              [pTooltip]="'COMMON.DELETE_CONFIRMATION' | translate"
              pTooltipPosition="left">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>
      }
    </div>
    }
  </pelu-card>
  }
</div>
