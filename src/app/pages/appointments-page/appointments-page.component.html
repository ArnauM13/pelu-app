<p-toast></p-toast>

<div class="container">
  <!-- Botó de menú lateral (filtres) a dalt a l'esquerra -->
  <div class="menu-filters-fab" *ngIf="popupStack().length === 0">
    <pelu-floating-button
      [config]="{ icon: '☰', tooltip: 'Filtres', ariaLabel: 'Obrir filtres', variant: 'primary', size: 'large', isActive: popupStack().length > 0 }"
      (clicked)="openFiltersPopup()">
    </pelu-floating-button>
  </div>

  <!-- Popup Stack -->
  <pelu-popup-stack
    [popups]="popupStack()"
    (popupClosed)="closePopup($event)">
  </pelu-popup-stack>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">📅</div>
      <div class="stat-content">
        <div class="stat-number">{{ totalAppointments() }}</div>
        <div class="stat-label">Total Cites</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">🎯</div>
      <div class="stat-content">
        <div class="stat-number">{{ todayAppointments() }}</div>
        <div class="stat-label">Cites Avui</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">⏰</div>
      <div class="stat-content">
        <div class="stat-number">{{ upcomingAppointments() }}</div>
        <div class="stat-label">Pròximes Cites</div>
      </div>
    </div>
  </div>

  <!-- View Mode Toggle (main action - right side) -->
  <div class="view-toggle-fab" role="group" aria-label="Canvia la vista de cites">
    @for (button of viewButtons(); track button.icon; let i = $index) {
    <pelu-floating-button
      [config]="button"
      (clicked)="onViewButtonClick(i)">
    </pelu-floating-button>
    }
  </div>

  <!-- Calendar View -->
  @if (viewMode() === 'calendar') {
  <pelu-card variant="large">
    <div class="card-header">
      <h3>📅 Calendari de Cites</h3>
      <p class="calendar-subtitle">Visualitza totes les teves cites en format calendari</p>
    </div>

    <div class="calendar-container">
      <p-calendar
        [(ngModel)]="selectedDate"
        (onSelect)="onDateSelect($event)"
        [inline]="true"
        [showOtherMonths]="true"
        [selectOtherMonths]="false"
        [firstDayOfWeek]="1"
        dateFormat="dd/mm/yy"
        [showIcon]="false">

        <ng-template pTemplate="date" let-date>
          <div class="calendar-day" [class.has-appointments]="getAppointmentsForDate(date).length > 0">
            <span class="day-number">{{ date.day }}</span>
            @if (getAppointmentsForDate(date).length > 0) {
            <div class="appointment-indicators">
              @for (appointment of getAppointmentsForDate(date); track appointment.id) {
              <div
                class="appointment-dot"
                [style.background-color]="getEventColor(appointment.data)"
                [pTooltip]="appointment.nom + ' - ' + formatTime(appointment.hora)">
              </div>
              }
            </div>
            }
          </div>
        </ng-template>
      </p-calendar>
    </div>

    <!-- Mostra la llista de cites o el missatge d'instrucció a sota del calendari -->
    @if (selectedDate()) {
    <div class="selected-date-appointments">
      <h4>📋 Cites del {{ formatDate(formatDateForDisplay(selectedDate()!)) }}</h4>
      @if (getAppointmentsForDate(selectedDate()!).length === 0) {
      <div class="empty-state">
        <div class="empty-icon">📅</div>
        <h3>No hi ha cites programades</h3>
        <p>Per aquesta data no tens cites programades. Pots seleccionar una altra data o afegir noves cites.</p>
      </div>
      } @else {
      <div class="appointments-list">
        @for (cita of getAppointmentsForDate(selectedDate()!); track cita.id) {
        <div class="appointment-item" [class.today]="isToday(cita.data)">
          <!-- Informació de la cita (esquerra) -->
          <div class="appointment-info">
            <div class="client-info">
              <h4 class="client-name">{{ cita.nom }}</h4>
              <div class="appointment-details">
                @if (cita.hora) {
                <div class="detail-item">
                  <span class="detail-icon">⏰</span>
                  <span class="detail-text">{{ formatTime(cita.hora) }}</span>
                </div>
                }
              </div>
            </div>
          </div>

          <!-- Status i accions (dreta) -->
          <div class="appointment-actions-container">
            <div class="appointment-status">
              @if (isToday(cita.data)) {
              <span class="status-badge today">Avui</span>
              }
            </div>

            <div class="appointment-actions">
              <button
                class="btn btn-danger"
                (click)="deleteAppointment(cita)"
                pTooltip="Eliminar cita"
                pTooltipPosition="left">
                🗑️
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }
    </div>
    } @else {
    <div class="calendar-instructions">
      <div class="instruction-content">
        <div class="instruction-icon">👆</div>
        <h4>Selecciona una data</h4>
        <p>Clica sobre qualsevol dia del calendari per veure les cites programades per a aquesta data.</p>
      </div>
    </div>
    }
  </pelu-card>
  }

  <!-- Appointments List View -->
  @if (viewMode() === 'list') {
  <pelu-card variant="large">
    <div class="card-header">
      <h3>Cites ({{ filteredCites().length }})</h3>
    </div>

    @if (filteredCites().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">📅</div>
      <h3>No hi ha cites</h3>
      <p>{{ filterDate() || filterClient() ? 'No s\'han trobat cites amb els filtres aplicats.' : 'Encara no tens cites programades.' }}</p>
      @if (filterDate() || filterClient()) {
      <button class="btn btn-primary" (click)="clearFilters()">
        Netejar Filtres
      </button>
      }
    </div>
    } @else {
    <div class="appointments-list">
      @for (cita of filteredCites(); track cita.id) {
      <div class="appointment-item" [class.today]="isToday(cita.data)" [class.past]="isPast(cita.data)">
        <!-- Informació de la cita (esquerra) -->
        <div class="appointment-info">
          <div class="client-info">
            <h4 class="client-name">{{ cita.nom }}</h4>
            <div class="appointment-details">
              <div class="detail-item">
                <span class="detail-icon">📅</span>
                <span class="detail-text">{{ formatDate(cita.data) }}</span>
              </div>

              @if (cita.hora) {
              <div class="detail-item">
                <span class="detail-icon">⏰</span>
                <span class="detail-text">{{ formatTime(cita.hora) }}</span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Status i accions (dreta) -->
        <div class="appointment-actions-container">
          <div class="appointment-status">
            @if (isToday(cita.data)) {
            <span class="status-badge today">Avui</span>
            } @else if (isPast(cita.data)) {
            <span class="status-badge past">Passada</span>
            }
          </div>

          <div class="appointment-actions">
            <button
              class="btn btn-danger"
              (click)="deleteAppointment(cita)"
              pTooltip="Eliminar cita"
              pTooltipPosition="left">
              🗑️
            </button>
          </div>
        </div>
      </div>
      }
    </div>
    }
  </pelu-card>
  }
</div>
